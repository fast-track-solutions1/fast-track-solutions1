from rest_framework import serializers
from django.contrib.auth.models import User
from .models import (
    Societe, Service, Grade, Departement, TypeAcces, OutilTravail, 
    Equipement, Salarie, AccesSalarie, HistoriqueSalarie, FichePoste, 
    OutilFichePoste, AmeliorationProposee
)

class SocieteSerializer(serializers.ModelSerializer):
    class Meta:
        model = Societe
        fields = '__all__'


class ServiceSerializer(serializers.ModelSerializer):
    class Meta:
        model = Service
        fields = '__all__'


class GradeSerializer(serializers.ModelSerializer):
    class Meta:
        model = Grade
        fields = '__all__'


class DepartementSerializer(serializers.ModelSerializer):
    class Meta:
        model = Departement
        fields = '__all__'


class TypeAccesSerializer(serializers.ModelSerializer):
    class Meta:
        model = TypeAcces
        fields = '__all__'


class OutilTravailSerializer(serializers.ModelSerializer):
    services_autorises = ServiceSerializer(many=True, read_only=True)
    grades_autorises = GradeSerializer(many=True, read_only=True)
    services_autorises_ids = serializers.PrimaryKeyRelatedField(
        many=True, 
        write_only=True, 
        queryset=Service.objects.all(),
        source='services_autorises'
    )
    grades_autorises_ids = serializers.PrimaryKeyRelatedField(
        many=True, 
        write_only=True, 
        queryset=Grade.objects.all(),
        source='grades_autorises'
    )
    
    class Meta:
        model = OutilTravail
        fields = '__all__'


class EquipementSerializer(serializers.ModelSerializer):
    class Meta:
        model = Equipement
        fields = '__all__'


class AccesSalarieSerializer(serializers.ModelSerializer):
    outil_nom = serializers.CharField(source='outil.nom', read_only=True)
    type_acces_nom = serializers.CharField(source='type_acces.nom', read_only=True)
    
    class Meta:
        model = AccesSalarie
        fields = '__all__'


class HistoriqueSalarieSerializer(serializers.ModelSerializer):
    ancien_grade_nom = serializers.CharField(source='ancien_grade.intitule', read_only=True)
    nouveau_grade_nom = serializers.CharField(source='nouveau_grade.intitule', read_only=True)
    
    class Meta:
        model = HistoriqueSalarie
        fields = '__all__'


class SalarieListSerializer(serializers.ModelSerializer):
    """Serializer simplifié pour les listes"""
    service_nom = serializers.CharField(source='service.nom', read_only=True)
    grade_nom = serializers.CharField(source='grade.intitule', read_only=True)
    responsable_nom = serializers.CharField(source='responsable_direct.nom_complet', read_only=True)
    
    class Meta:
        model = Salarie
        fields = [
            'id', 'matricule', 'nom', 'prenom', 'email_professionnel',
            'service_nom', 'grade_nom', 'poste', 'date_entree', 
            'actif', 'responsable_nom', 'genre'
        ]


class SalarieDetailSerializer(serializers.ModelSerializer):
    """Serializer complet pour les détails"""
    acces_outils = AccesSalarieSerializer(many=True, read_only=True)
    historique = HistoriqueSalarieSerializer(many=True, read_only=True)
    zones_geographiques = DepartementSerializer(many=True, read_only=True)
    zones_geographiques_ids = serializers.PrimaryKeyRelatedField(
        many=True, 
        write_only=True, 
        queryset=Departement.objects.all(),
        source='zones_geographiques'
    )
    responsable_nom = serializers.CharField(source='responsable_direct.nom_complet', read_only=True)
    service_details = ServiceSerializer(source='service', read_only=True)
    grade_details = GradeSerializer(source='grade', read_only=True)
    
    class Meta:
        model = Salarie
        fields = '__all__'


class OutilFichePosteSerializer(serializers.ModelSerializer):
    outil_nom = serializers.CharField(source='outil.nom', read_only=True)
    type_acces_nom = serializers.CharField(source='type_acces_requis.nom', read_only=True)
    
    class Meta:
        model = OutilFichePoste
        fields = '__all__'


class AmeliorationProposeeSerializer(serializers.ModelSerializer):
    service_nom = serializers.CharField(source='service_concerne.nom', read_only=True)
    responsable_nom = serializers.CharField(source='responsable_projet.nom_complet', read_only=True)
    
    class Meta:
        model = AmeliorationProposee
        fields = '__all__'


class FichePosteListSerializer(serializers.ModelSerializer):
    """Serializer simplifié pour les listes"""
    service_nom = serializers.CharField(source='service.nom', read_only=True)
    grade_nom = serializers.CharField(source='grade.intitule', read_only=True)
    responsable_nom = serializers.CharField(source='responsable_hierarchique.nom_complet', read_only=True)
    
    class Meta:
        model = FichePoste
        fields = [
            'id', 'code_fiche', 'intitule', 'service_nom', 'grade_nom',
            'responsable_nom', 'statut', 'date_creation', 'date_modification'
        ]


class FichePosteDetailSerializer(serializers.ModelSerializer):
    """Serializer complet pour les détails"""
    outils_utilises = OutilFichePosteSerializer(
        source='outilficheposte_set', 
        many=True, 
        read_only=True
    )
    ameliorations = AmeliorationProposeeSerializer(many=True, read_only=True)
    service_details = ServiceSerializer(source='service', read_only=True)
    grade_details = GradeSerializer(source='grade', read_only=True)
    responsable_details = SalarieListSerializer(source='responsable_hierarchique', read_only=True)
    
    class Meta:
        model = FichePoste
        fields = '__all__'


class DashboardStatsSerializer(serializers.Serializer):
    """Serializer pour les statistiques du dashboard"""
    total_salaries = serializers.IntegerField()
    total_services = serializers.IntegerField()
    total_grades = serializers.IntegerField()
    total_departements_actifs = serializers.IntegerField()
    total_outils = serializers.IntegerField()
    total_fiches_poste = serializers.IntegerField()
    total_circuits = serializers.IntegerField()
    
    # Répartition par genre
    total_hommes = serializers.IntegerField()
    total_femmes = serializers.IntegerField()
    
    # Répartition par service
    salaries_par_service = serializers.ListField()
    
    # Répartition par grade
    salaries_par_grade = serializers.ListField()
    
    # Répartition par département
    salaries_par_departement = serializers.ListField()
    
    # Répartition par genre par service
    genre_par_service = serializers.ListField()
    
    # Répartition par genre par département
    genre_par_departement = serializers.ListField()
