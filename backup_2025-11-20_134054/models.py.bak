from django.db import models
from django.contrib.auth.models import User
from django.core.validators import MinValueValidator, MaxValueValidator
from datetime import datetime, date

# ============================================================================
# MODÈLES EXISTANTS (À GARDER)
# ============================================================================

class Societe(models.Model):
    """Modèle pour les informations de la société MSI"""
    nom = models.CharField(max_length=255, unique=True)
    email = models.EmailField()
    telephone = models.CharField(max_length=20)
    adresse = models.CharField(max_length=500)
    ville = models.CharField(max_length=100)
    code_postal = models.CharField(max_length=10)
    pays = models.CharField(max_length=100, default="France")
    client = models.CharField(max_length=255, default="ADANEV MOBILITES")
    activite = models.CharField(max_length=500)
    date_creation = models.DateTimeField(auto_now_add=True)
    date_modification = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = "Société"
        verbose_name_plural = "Sociétés"

    def __str__(self):
        return self.nom


class Service(models.Model):
    """Services disponibles dans l'entreprise"""
    societe = models.ForeignKey(Societe, on_delete=models.CASCADE, related_name='services')
    nom = models.CharField(max_length=255)
    actif = models.BooleanField(default=True)
    date_creation = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Service"
        verbose_name_plural = "Services"
        unique_together = ('societe', 'nom')

    def __str__(self):
        return f"{self.nom} ({self.societe.nom})"


class Grade(models.Model):
    """Grades/Postes disponibles"""
    societe = models.ForeignKey(Societe, on_delete=models.CASCADE, related_name='grades')
    intitule = models.CharField(max_length=255)
    actif = models.BooleanField(default=True)
    date_creation = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Grade"
        verbose_name_plural = "Grades"
        unique_together = ('societe', 'intitule')

    def __str__(self):
        return f"{self.intitule} ({self.societe.nom})"


class Departement(models.Model):
    """Départements de l'entreprise"""
    numero = models.CharField(max_length=10, unique=True)
    nom = models.CharField(max_length=255)
    societe = models.ForeignKey(Societe, on_delete=models.CASCADE, related_name='departements')
    region = models.CharField(max_length=100, blank=True, null=True)
    actif = models.BooleanField(default=True)
    date_creation = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Département"
        verbose_name_plural = "Départements"
        unique_together = ('societe', 'numero')

    def __str__(self):
        return f"{self.numero} - {self.nom}"


class TypeAcces(models.Model):
    """Types d'accès possibles"""
    societe = models.ForeignKey(Societe, on_delete=models.CASCADE, related_name='types_acces')
    nom = models.CharField(max_length=255)
    description = models.TextField(blank=True, null=True)
    actif = models.BooleanField(default=True)

    class Meta:
        verbose_name = "Type d'Accès"
        verbose_name_plural = "Types d'Accès"

    def __str__(self):
        return self.nom


class OutilTravail(models.Model):
    """Outils de travail disponibles"""
    societe = models.ForeignKey(Societe, on_delete=models.CASCADE, related_name='outils_travail')
    nom = models.CharField(max_length=255)
    categorie = models.CharField(max_length=100)
    actif = models.BooleanField(default=True)

    class Meta:
        verbose_name = "Outil de Travail"
        verbose_name_plural = "Outils de Travail"

    def __str__(self):
        return self.nom


class Equipement(models.Model):
    """Équipements disponibles"""
    societe = models.ForeignKey(Societe, on_delete=models.CASCADE, related_name='equipements')
    nom = models.CharField(max_length=255)
    type_equipement = models.CharField(max_length=100)
    marque = models.CharField(max_length=100, blank=True)
    modele = models.CharField(max_length=100, blank=True)
    numero_serie = models.CharField(max_length=100, unique=True)
    actif = models.BooleanField(default=True)

    class Meta:
        verbose_name = "Équipement"
        verbose_name_plural = "Équipements"

    def __str__(self):
        return self.nom


# ============================================================================
# MODÈLE SALARIE - MODIFIÉ
# ============================================================================

class Salarie(models.Model):
    """Modèle pour les salariés"""
    TYPE_CONTRAT = [
        ('cdi', 'CDI'),
        ('civp', 'CIVP'),
        ('stage', 'Stage'),
        ('autre', 'Autre'),
    ]

    societe = models.ForeignKey(Societe, on_delete=models.CASCADE, related_name='salaries')
    service = models.ForeignKey(Service, on_delete=models.SET_NULL, null=True, blank=True)
    departement = models.ForeignKey(Departement, on_delete=models.SET_NULL, null=True, blank=True)
    grade = models.ForeignKey(Grade, on_delete=models.SET_NULL, null=True, blank=True)
    
    # Informations personnelles
    prenom = models.CharField(max_length=100)
    nom = models.CharField(max_length=100)
    date_naissance = models.DateField(blank=True, null=True)
    lieu_naissance = models.CharField(max_length=255, blank=True, null=True, help_text="Non visible pour l'utilisateur")
    email_personnel = models.EmailField(blank=True, null=True)
    email_professionnel = models.EmailField(unique=True)
    telephone_personnel = models.CharField(max_length=20, blank=True, null=True)
    telephone_professionnel = models.CharField(max_length=20, blank=True, null=True)
    
    # Accès et identification
    numero_professionnel = models.CharField(max_length=50, unique=True)
    extension_3cx = models.CharField(max_length=20, blank=True, null=True)
    
    # Contrat
    type_contrat = models.CharField(max_length=20, choices=TYPE_CONTRAT, default='cdi')
    date_embauche = models.DateField()
    date_fin_civp = models.DateField(blank=True, null=True, help_text="À remplir si CIVP")
    
    # Salaire
    salaire_net = models.DecimalField(max_digits=10, decimal_places=2)
    salaire_brut = models.DecimalField(max_digits=10, decimal_places=2, blank=True, null=True)
    
    # Métadonnées
    actif = models.BooleanField(default=True)
    date_creation = models.DateTimeField(auto_now_add=True)
    date_modification = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = "Salarié"
        verbose_name_plural = "Salariés"

    def __str__(self):
        return f"{self.prenom} {self.nom}"


# ============================================================================
# NOUVEAUX MODÈLES POUR GESTION AVANCÉE
# ============================================================================

class EquipementInstance(models.Model):
    """Instance physique d'équipement assignée à un salarié"""
    ETAT_CHOICES = [
        ('neuf', 'Neuf'),
        ('bon', 'Bon'),
        ('use', 'Usé'),
        ('casse', 'Cassé'),
    ]
    
    societe = models.ForeignKey(Societe, on_delete=models.CASCADE)
    nom = models.CharField(max_length=255)
    marque = models.CharField(max_length=100)
    modele = models.CharField(max_length=100)
    numero_serie = models.CharField(max_length=100, unique=True)
    type_equipement = models.CharField(max_length=100)
    etat = models.CharField(max_length=20, choices=ETAT_CHOICES)
    salarié = models.ForeignKey(Salarie, on_delete=models.SET_NULL, null=True, blank=True, related_name='equipements_instances')
    date_assignation = models.DateField(null=True, blank=True)
    date_acquisition = models.DateField()
    actif = models.BooleanField(default=True)
    date_creation = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Équipement Instance"
        verbose_name_plural = "Équipements Instances"

    def __str__(self):
        return f"{self.nom} ({self.numero_serie})"


class CreneauTravail(models.Model):
    """Créneau de travail prédéfini"""
    societe = models.ForeignKey(Societe, on_delete=models.CASCADE)
    nom = models.CharField(max_length=100)
    heure_debut = models.TimeField()
    heure_fin = models.TimeField()
    duree_pause_minutes = models.IntegerField()
    actif = models.BooleanField(default=True)

    class Meta:
        verbose_name = "Créneau Travail"
        verbose_name_plural = "Créneau Travails"

    def __str__(self):
        return f"{self.nom} ({self.heure_debut} - {self.heure_fin})"


class HoraireSalarie(models.Model):
    """Horaire de travail assigné à un salarié"""
    TYPE_HORAIRE = [
        ('creneau', 'Créneau défini'),
        ('flexible', 'Flexible'),
    ]
    
    salarié = models.ForeignKey(Salarie, on_delete=models.CASCADE, related_name='horaires')
    type_horaire = models.CharField(max_length=20, choices=TYPE_HORAIRE)
    
    # Si créneau défini
    creneau = models.ForeignKey(CreneauTravail, on_delete=models.SET_NULL, null=True, blank=True)
    
    # Si flexible
    heure_debut = models.TimeField(null=True, blank=True)
    heure_fin = models.TimeField(null=True, blank=True)
    duree_pause_minutes = models.IntegerField(null=True, blank=True)
    
    date_entree_vigueur = models.DateField()
    actif = models.BooleanField(default=True)

    class Meta:
        verbose_name = "Horaire Salarié"
        verbose_name_plural = "Horaires Salariés"

    def __str__(self):
        return f"{self.salarié.prenom} {self.salarié.nom} - {self.type_horaire}"


class DocumentSalarie(models.Model):
    """Documents (contrat, fiche de paie, etc.) assignés à un salarié"""
    TYPE_DOCUMENT = [
        ('contrat', 'Contrat'),
        ('fiche_paie', 'Fiche de paie'),
        ('copie_cin', 'Copie CIN'),
        ('autre', 'Autre'),
    ]
    
    salarié = models.ForeignKey(Salarie, on_delete=models.CASCADE, related_name='documents')
    type_document = models.CharField(max_length=50, choices=TYPE_DOCUMENT)
    fichier = models.FileField(upload_to='documents_salaries/%Y/%m/')
    date_upload = models.DateTimeField(auto_now_add=True)
    visible_salarié = models.BooleanField(default=True)
    uploadeur = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True)

    class Meta:
        verbose_name = "Document Salarié"
        verbose_name_plural = "Documents Salariés"
        permissions = [
            ('can_upload_documents', 'Peut uploader des documents'),
        ]

    def __str__(self):
        return f"{self.salarié.prenom} {self.salarié.nom} - {self.type_document}"


class DemandeConge(models.Model):
    """Demande de congé"""
    STATUT_CHOICES = [
        ('en_attente', 'En attente'),
        ('approuve', 'Approuvé'),
        ('rejete', 'Rejeté'),
    ]
    
    salarié = models.ForeignKey(Salarie, on_delete=models.CASCADE, related_name='demandes_conges')
    date_debut = models.DateField()
    date_fin = models.DateField()
    nombre_jours = models.IntegerField()
    raison = models.TextField(blank=True, null=True)
    statut = models.CharField(max_length=20, choices=STATUT_CHOICES, default='en_attente')
    responsable_validateur = models.ForeignKey(Salarie, on_delete=models.SET_NULL, 
                                              null=True, blank=True, related_name='conges_a_valider')
    date_validation = models.DateTimeField(null=True, blank=True)
    date_creation = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Demande Congé"
        verbose_name_plural = "Demandes Congés"

    def __str__(self):
        return f"{self.salarié.prenom} {self.salarié.nom} - {self.date_debut}"


class SoldeConge(models.Model):
    """Solde de congé annuel"""
    salarié = models.ForeignKey(Salarie, on_delete=models.CASCADE, related_name='soldes_conges')
    annee = models.IntegerField()
    solde_initial = models.DecimalField(max_digits=5, decimal_places=2)
    jours_droit_par_mois = models.DecimalField(max_digits=5, decimal_places=2, default=2.5)
    congés_utilises = models.DecimalField(max_digits=5, decimal_places=2, default=0)

    class Meta:
        verbose_name = "Solde Congé"
        verbose_name_plural = "Soldes Congés"
        unique_together = ('salarié', 'annee')

    def __str__(self):
        return f"{self.salarié.prenom} {self.salarié.nom} - {self.annee}"


class TravauxExceptionnels(models.Model):
    """Travaux exceptionnels (weekend, dimanche)"""
    TYPE_CHOICES = [
        ('weekend', 'Weekend'),
        ('dimanche', 'Dimanche'),
    ]
    
    STATUT_CHOICES = [
        ('mentionne', 'Mentionné'),
        ('valide_responsable', 'Validé responsable'),
        ('valide_direction', 'Validé direction'),
    ]
    
    salarié = models.ForeignKey(Salarie, on_delete=models.CASCADE, related_name='travaux_exceptionnels')
    date_travail = models.DateField()
    type_travail = models.CharField(max_length=20, choices=TYPE_CHOICES)
    heure_debut = models.TimeField()
    heure_fin = models.TimeField()
    description = models.TextField()
    statut = models.CharField(max_length=30, choices=STATUT_CHOICES, default='mentionne')
    responsable_validation = models.ForeignKey(Salarie, on_delete=models.SET_NULL, 
                                              null=True, blank=True, related_name='travaux_a_valider')
    date_validation = models.DateTimeField(null=True, blank=True)
    date_creation = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Travaux Exceptionnels"
        verbose_name_plural = "Travaux Exceptionnels"

    def __str__(self):
        return f"{self.salarié.prenom} {self.salarié.nom} - {self.date_travail}"


class TypeApplicationAcces(models.Model):
    """Type d'application/accès"""
    societe = models.ForeignKey(Societe, on_delete=models.CASCADE)
    nom = models.CharField(max_length=255)
    categorie = models.CharField(max_length=100)
    actif = models.BooleanField(default=True)

    class Meta:
        verbose_name = "Type Application Accès"
        verbose_name_plural = "Types Applications Accès"

    def __str__(self):
        return f"{self.nom} ({self.categorie})"


class AccesApplication(models.Model):
    """Accès application avec credentials"""
    salarié = models.ForeignKey(Salarie, on_delete=models.CASCADE, related_name='acces_applications')
    application = models.ForeignKey(TypeApplicationAcces, on_delete=models.CASCADE)
    login = models.CharField(max_length=255)
    mot_de_passe = models.CharField(max_length=255)  # À CHIFFRER EN PROD
    lien_web = models.URLField(blank=True, null=True)
    vpn_actif = models.BooleanField(default=False)
    vpn_login = models.CharField(max_length=255, blank=True, null=True)
    vpn_mot_de_passe = models.CharField(max_length=255, blank=True, null=True)  # À CHIFFRER EN PROD
    date_creation = models.DateTimeField(auto_now_add=True)
    actif = models.BooleanField(default=True)

    class Meta:
        verbose_name = "Accès Application"
        verbose_name_plural = "Accès Applications"
        permissions = [
            ('can_view_credentials', 'Peut voir les credentials'),
        ]

    def __str__(self):
        return f"{self.salarié.prenom} {self.salarié.nom} - {self.application.nom}"


class FicheParametresUser(models.Model):
    """Fiche paramétrée pour l'utilisateur (générée auto)"""
    salarié = models.OneToOneField(Salarie, on_delete=models.CASCADE, related_name='fiche_parametres')
    date_generation = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = "Fiche Paramètres User"
        verbose_name_plural = "Fiches Paramètres Users"

    def __str__(self):
        return f"Fiche {self.salarié.prenom} {self.salarié.nom}"


# ============================================================================
# MODÈLES SUPPLÉMENTAIRES (ANCIENS - À VÉRIFIER)
# ============================================================================

class AccesSalarie(models.Model):
    """Accès assignés aux salariés"""
    salarié = models.ForeignKey(Salarie, on_delete=models.CASCADE, related_name='acces')
    type_acces = models.ForeignKey(TypeAcces, on_delete=models.CASCADE)
    date_debut = models.DateField()
    date_fin = models.DateField(blank=True, null=True)
    actif = models.BooleanField(default=True)
    date_creation = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Accès Salarié"
        verbose_name_plural = "Accès Salariés"

    def __str__(self):
        return f"{self.salarié} - {self.type_acces}"


class HistoriqueSalarie(models.Model):
    """Historique des modifications du profil salarié"""
    salarié = models.ForeignKey(Salarie, on_delete=models.CASCADE, related_name='historique')
    type_modification = models.CharField(max_length=100)
    description = models.TextField()
    date_modification = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Historique Salarié"
        verbose_name_plural = "Historiques Salariés"

    def __str__(self):
        return f"{self.salarié} - {self.type_modification}"


class FichePoste(models.Model):
    """Fiche de poste du salarié"""
    salarié = models.ForeignKey(Salarie, on_delete=models.CASCADE, related_name='fiches_poste')
    titre = models.CharField(max_length=255)
    description = models.TextField()
    responsabilites = models.TextField()
    competences_requises = models.TextField()
    date_creation = models.DateTimeField(auto_now_add=True)
    date_modification = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = "Fiche Poste"
        verbose_name_plural = "Fiches Postes"

    def __str__(self):
        return f"{self.salarié} - {self.titre}"


class OutilFichePoste(models.Model):
    """Outils liés à une fiche de poste"""
    fiche_poste = models.ForeignKey(FichePoste, on_delete=models.CASCADE, related_name='outils')
    outil_travail = models.ForeignKey(OutilTravail, on_delete=models.CASCADE)
    obligatoire = models.BooleanField(default=True)

    class Meta:
        verbose_name = "Outil Fiche Poste"
        verbose_name_plural = "Outils Fiches Postes"

    def __str__(self):
        return f"{self.fiche_poste} - {self.outil_travail}"


class AmeliorationProposee(models.Model):
    """Améliorations proposées par les salariés"""
    salarié = models.ForeignKey(Salarie, on_delete=models.CASCADE, related_name='ameliorations')
    titre = models.CharField(max_length=255)
    description = models.TextField()
    statut = models.CharField(max_length=50, choices=[
        ('proposee', 'Proposée'),
        ('en_cours', 'En cours'),
        ('realisee', 'Réalisée'),
    ], default='proposee')
    date_creation = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Amélioration Proposée"
        verbose_name_plural = "Améliorations Proposées"

    def __str__(self):
        return f"{self.salarié} - {self.titre}"
