from rest_framework import viewsets, status, filters
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django.db.models import Q, Count, F
from django.db.models.functions import TruncDate
from django_filters.rest_framework import DjangoFilterBackend
from datetime import datetime, timedelta

from .models import (
    Societe, Service, Grade, Departement, TypeAcces, OutilTravail,
    Equipement, Salarie, AccesSalarie, HistoriqueSalarie, FichePoste,
    OutilFichePoste, AmeliorationProposee
)
from .serializers import (
    SocieteSerializer, ServiceSerializer, GradeSerializer,
    DepartementSerializer, TypeAccesSerializer, OutilTravailSerializer,
    EquipementSerializer, AccesSalarieSerializer, HistoriqueSalarieSerializer,
    SalarieListSerializer, SalarieDetailSerializer, FichePosteListSerializer,
    FichePosteDetailSerializer, OutilFichePosteSerializer,
    AmeliorationProposeeSerializer, DashboardStatsSerializer
)


class SocieteViewSet(viewsets.ModelViewSet):
    """ViewSet pour la gestion de la Société"""
    queryset = Societe.objects.all()
    serializer_class = SocieteSerializer
    permission_classes = [IsAuthenticated]


class ServiceViewSet(viewsets.ModelViewSet):
    """ViewSet pour la gestion des Services"""
    serializer_class = ServiceSerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter]
    filterset_fields = ['societe', 'actif']
    search_fields = ['nom', 'description']
    
    def get_queryset(self):
        return Service.objects.filter(societe=self.request.user.societe if hasattr(self.request.user, 'societe') else None)


class GradeViewSet(viewsets.ModelViewSet):
    """ViewSet pour la gestion des Grades"""
    serializer_class = GradeSerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['societe', 'actif']
    search_fields = ['intitule']
    ordering_fields = ['niveau_hierarchique', 'intitule']
    
    def get_queryset(self):
        return Grade.objects.filter(societe=self.request.user.societe if hasattr(self.request.user, 'societe') else None)


class DepartementViewSet(viewsets.ModelViewSet):
    """ViewSet pour la gestion des Départements"""
    serializer_class = DepartementSerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter]
    filterset_fields = ['societe', 'region', 'actif']
    search_fields = ['nom', 'numero', 'prefecture', 'region']
    
    def get_queryset(self):
        return Departement.objects.filter(societe=self.request.user.societe if hasattr(self.request.user, 'societe') else None)


class TypeAccesViewSet(viewsets.ModelViewSet):
    """ViewSet pour la gestion des Types d'Accès"""
    serializer_class = TypeAccesSerializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        return TypeAcces.objects.filter(societe=self.request.user.societe if hasattr(self.request.user, 'societe') else None)


class OutilTravailViewSet(viewsets.ModelViewSet):
    """ViewSet pour la gestion des Outils de Travail"""
    serializer_class = OutilTravailSerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter]
    filterset_fields = ['societe', 'categorie', 'actif']
    search_fields = ['nom', 'description']
    
    def get_queryset(self):
        return OutilTravail.objects.filter(societe=self.request.user.societe if hasattr(self.request.user, 'societe') else None)


class EquipementViewSet(viewsets.ModelViewSet):
    """ViewSet pour la gestion des Équipements"""
    serializer_class = EquipementSerializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        return Equipement.objects.filter(societe=self.request.user.societe if hasattr(self.request.user, 'societe') else None)


class SalarieViewSet(viewsets.ModelViewSet):
    """ViewSet pour la gestion des Salariés"""
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_fields = ['service', 'grade', 'statut', 'genre', 'type_contrat']
    search_fields = ['nom', 'prenom', 'matricule', 'email_professionnel']
    ordering_fields = ['nom', 'date_entree', 'date_creation']
    
    def get_queryset(self):
        societe = self.request.user.societe if hasattr(self.request.user, 'societe') else None
        return Salarie.objects.filter(societe=societe)
    
    def get_serializer_class(self):
        if self.action == 'retrieve':
            return SalarieDetailSerializer
        return SalarieListSerializer
    
    @action(detail=True, methods=['get'])
    def historique(self, request, pk=None):
        """Récupère l'historique d'un salarié"""
        salarie = self.get_object()
        historique = salarie.historique.all()
        serializer = HistoriqueSalarieSerializer(historique, many=True)
        return Response(serializer.data)
    
    @action(detail=True, methods=['get'])
    def acces_outils(self, request, pk=None):
        """Récupère les accès aux outils d'un salarié"""
        salarie = self.get_object()
        acces = salarie.acces_outils.filter(actif=True)
        serializer = AccesSalarieSerializer(acces, many=True)
        return Response(serializer.data)
    
    @action(detail=False, methods=['get'])
    def par_service(self, request):
        """Récupère les salariés groupés par service"""
        societe = self.request.user.societe if hasattr(self.request.user, 'societe') else None
        salaries_par_service = Service.objects.filter(societe=societe).annotate(
            count=Count('salaries')
        ).values('nom', 'count')
        return Response(list(salaries_par_service))
    
    @action(detail=False, methods=['get'])
    def par_genre_et_service(self, request):
        """Récupère les salariés par genre et service"""
        societe = self.request.user.societe if hasattr(self.request.user, 'societe') else None
        data = Salarie.objects.filter(societe=societe).values(
            'genre', 'service__nom'
        ).annotate(count=Count('id')).order_by('service__nom', 'genre')
        return Response(list(data))
    
    @action(detail=False, methods=['get'])
    def par_genre_et_departement(self, request):
        """Récupère les salariés par genre et département"""
        societe = self.request.user.societe if hasattr(self.request.user, 'societe') else None
        data = Salarie.objects.filter(
            societe=societe,
            zones_geographiques__isnull=False
        ).values(
            'genre', 'zones_geographiques__nom'
        ).annotate(count=Count('id')).order_by('zones_geographiques__nom', 'genre')
        return Response(list(data))


class AccesSalarieViewSet(viewsets.ModelViewSet):
    """ViewSet pour la gestion des Accès Salariés"""
    serializer_class = AccesSalarieSerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend]
    filterset_fields = ['salarie', 'outil', 'actif']
    
    def get_queryset(self):
        return AccesSalarie.objects.all()


class HistoriqueSalarieViewSet(viewsets.ModelViewSet):
    """ViewSet pour la gestion de l'Historique Salarié"""
    serializer_class = HistoriqueSalarieSerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend]
    filterset_fields = ['salarie', 'type_changement']
    
    def get_queryset(self):
        return HistoriqueSalarie.objects.all()


class FichePosteViewSet(viewsets.ModelViewSet):
    """ViewSet pour la gestion des Fiches de Poste"""
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.SearchFilter]
    filterset_fields = ['service', 'grade', 'statut']
    search_fields = ['code_fiche', 'intitule', 'description']
    
    def get_queryset(self):
        societe = self.request.user.societe if hasattr(self.request.user, 'societe') else None
        return FichePoste.objects.filter(societe=societe)
    
    def get_serializer_class(self):
        if self.action == 'retrieve':
            return FichePosteDetailSerializer
        return FichePosteListSerializer
    
    @action(detail=True, methods=['get'])
    def ameliorations(self, request, pk=None):
        """Récupère les améliorations proposées"""
        fiche = self.get_object()
        ameliorations = fiche.ameliorations.all()
        serializer = AmeliorationProposeeSerializer(ameliorations, many=True)
        return Response(serializer.data)


class AmeliorationProposeeViewSet(viewsets.ModelViewSet):
    """ViewSet pour la gestion des Améliorations Proposées"""
    serializer_class = AmeliorationProposeeSerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend, filters.OrderingFilter]
    filterset_fields = ['fiche_poste', 'priorite', 'statut_projet']
    ordering_fields = ['priorite', 'date_creation']
    
    def get_queryset(self):
        return AmeliorationProposee.objects.all()


class DashboardViewSet(viewsets.ViewSet):
    """ViewSet pour les statistiques du Dashboard"""
    permission_classes = [IsAuthenticated]
    
    @action(detail=False, methods=['get'])
    def statistiques(self, request):
        """Retourne les statistiques complètes pour le dashboard"""
        societe = request.user.societe if hasattr(request.user, 'societe') else None
        
        # Counts basiques
        stats = {
            'total_salaries': Salarie.objects.filter(societe=societe, actif=True).count(),
            'total_services': Service.objects.filter(societe=societe, actif=True).count(),
            'total_grades': Grade.objects.filter(societe=societe, actif=True).count(),
            'total_departements_actifs': Departement.objects.filter(societe=societe, actif=True).count(),
            'total_outils': OutilTravail.objects.filter(societe=societe, actif=True).count(),
            'total_fiches_poste': FichePoste.objects.filter(societe=societe, statut='actif').count(),
            'total_circuits': Departement.objects.filter(societe=societe, actif=True).aggregate(
                total=Count('nombre_circuits', filter=Q(nombre_circuits__gt=0))
            )['total'] or 0,
            
            # Genre
            'total_hommes': Salarie.objects.filter(societe=societe, genre='M', actif=True).count(),
            'total_femmes': Salarie.objects.filter(societe=societe, genre='F', actif=True).count(),
            
            # Par service
            'salaries_par_service': list(
                Salarie.objects.filter(societe=societe, actif=True).values(
                    'service__nom'
                ).annotate(count=Count('id')).order_by('-count')
            ),
            
            # Par grade
            'salaries_par_grade': list(
                Salarie.objects.filter(societe=societe, actif=True).values(
                    'grade__intitule'
                ).annotate(count=Count('id')).order_by('-count')
            ),
            
            # Par département
            'salaries_par_departement': list(
                Salarie.objects.filter(
                    societe=societe,
                    zones_geographiques__isnull=False,
                    actif=True
                ).distinct().values(
                    'zones_geographiques__nom',
                    'zones_geographiques__numero'
                ).annotate(count=Count('id')).order_by('-count')
            ),
        }
        
        serializer = DashboardStatsSerializer(stats)
        return Response(serializer.data)
