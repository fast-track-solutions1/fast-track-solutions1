# Guide Docker & Serveur Django - SmartFlow

**Auteur :** Haithem Ferjani  
**Projet :** MSI TeamHub (SmartFlow)  
**Date :** 19 novembre 2025  
**Stack :** Django + PostgreSQL + Docker

---

## Table des matières

1. [Démarrer le serveur](#démarrer-le-serveur)
2. [Arrêter proprement](#arrêter-proprement)
3. [Vérifier l'état des containers](#vérifier-létat-des-containers)
4. [Vérifier la santé de la base de données](#vérifier-la-santé-de-la-base-de-données)
5. [Accéder à l'application](#accéder-à-lapplication)
6. [Résoudre les problèmes courants](#résoudre-les-problèmes-courants)
7. [Commandes Docker essentielles](#commandes-docker-essentielles)

---

## Démarrer le serveur

### Procédure complète

1. **Ouvre PowerShell ou CMD**

2. **Va dans le dossier du projet**
   ```powershell
   E:
   cd smartflow
   ```

3. **Lance les services (Django + PostgreSQL + Réseau)**
   ```powershell
   docker-compose up -d
   ```
   - Le `-d` lance les services en arrière-plan (non bloquant)
   - Tu verras les statuts : "Creating", "Starting", "Created", "Healthy", "Started"

4. **Vérifie que tout tourne**
   ```powershell
   docker ps
   ```
   - Tu dois voir 2 containers :
     - `msi_web` (Django) → **Up**
     - `msi_db` (PostgreSQL) → **Up (healthy)**

### Logs de démarrage réussi

```
[+] Running 3/3
 ✔ Network smartflow_default  Created                              0.0s
 ✔ Container msi_db           Healthy                             11.1s
 ✔ Container msi_web          Started                             11.3s
```

---

## Arrêter proprement

### Commande pour arrêter tous les services

```powershell
docker-compose down
```

- Cela arrête tous les containers du projet
- Les données de la base (volumes) restent intactes
- Aucune perte d'informations

### Logs d'arrêt réussi

```
[+] Running 3/3
 ✔ Container msi_web          Removed                             0.0s
 ✔ Container msi_db           Removed                             0.0s
 ✔ Network smartflow_default  Removed                             0.4s
```

---

## Vérifier l'état des containers

### Voir les containers ACTIFS

```powershell
docker ps
```

**Résultat attendu :**
```
CONTAINER ID   IMAGE                COMMAND                  STATUS
8a23a93b0267   smartflow-web        "sh -c 'python manag…"   Up 33 minutes
7fcb2bc38a3a   postgres:15-alpine   "docker-entrypoint.s…"   Up 33 minutes (healthy)

PORTS
0.0.0.0:8000->8000/tcp
0.0.0.0:5432->5432/tcp
```

- **STATUS "Up"** = container actif
- **STATUS "Up (healthy)"** = container actif + santé vérifiée (database OK)

### Voir TOUS les containers (actifs + arrêtés)

```powershell
docker ps -a
```

---

## Vérifier la santé de la base de données

### Commande de vérification complète

```powershell
docker inspect --format='{{json .State.Health}}' msi_db
```

### Résultat attendu (tout va bien)

```json
{
  "Status": "healthy",
  "FailingStreak": 0,
  "Log": [
    {
      "Start": "2025-11-19T11:17:17.660155983Z",
      "End": "2025-11-19T11:17:17.758624862Z",
      "ExitCode": 0,
      "Output": "/var/run/postgresql:5432 - accepting connections\n"
    }
  ]
}
```

**Interprétation :**
- **Status: "healthy"** = base OK
- **FailingStreak: 0** = aucun échec récent
- **ExitCode: 0** = test de connexion réussi
- **Output: "accepting connections"** = port 5432 accepte les connexions

---

## Accéder à l'application

### URLs principales

| Service | URL | Description |
|---------|-----|-------------|
| **Application Web** | http://localhost:8000/ | Page d'accueil MSI TeamHub |
| **Admin Django** | http://localhost:8000/admin/ | Panneau d'administration Django |
| **API Services** | http://localhost:8000/api/services/ | Listing des services (JSON) |
| **API Grades** | http://localhost:8000/api/grades/ | Listing des grades (JSON) |
| **API Salariés** | http://localhost:8000/api/salaries/ | Listing des salariés (JSON) |
| **Base de données** | localhost:5432 | Connexion PostgreSQL interne |

### Test rapide des APIs

```bash
# Depuis PowerShell, tu peux utiliser curl :
curl http://localhost:8000/api/services/
curl http://localhost:8000/api/grades/
curl http://localhost:8000/api/salaries/
```

---

## Résoudre les problèmes courants

### Problème 1 : Container "Exited" ou s'arrête

**Cause probable :** Crash du service ou initialisation échouée

**Solution :**
```powershell
docker-compose down
docker-compose up -d
```

Puis vérifie l'état :
```powershell
docker ps
```

### Problème 2 : Container "Unhealthy"

**Cause probable :** Problème de connexion à la base ou ressource insuffisante

**Solution :** Consulte les logs
```powershell
docker logs msi_db --tail=40
```

Puis redémarre :
```powershell
docker-compose down
docker-compose up -d
```

### Problème 3 : Port 8000 ou 5432 déjà occupé

**Cause probable :** Un autre service utilise le port

**Solution :** Vérifier les connexions
```powershell
netstat -aon | findstr :8000
netstat -aon | findstr :5432
```

Si un port est occupé, arrête le service local qui l'utilise ou change le port dans `docker-compose.yml`.

### Problème 4 : UnicodeDecodeError lors du démarrage

**Cause probable :** Caractère spécial non UTF-8 dans settings.py ou .env

**Solution :**
- Ouvre `settings.py` dans VSCode
- Menu "Encodage" → **UTF-8 (sans BOM)**
- Sauvegarde
- Redémarre : `docker-compose down` puis `docker-compose up -d`

---

## Commandes Docker essentielles

### Gestion des containers

| Commande | Description |
|----------|-------------|
| `docker-compose up -d` | Démarrer tous les services en arrière-plan |
| `docker-compose down` | Arrêter et supprimer tous les containers |
| `docker ps` | Lister les containers actifs |
| `docker ps -a` | Lister tous les containers |
| `docker start nom_container` | Démarrer un container spécifique |
| `docker stop nom_container` | Arrêter un container spécifique |
| `docker restart nom_container` | Redémarrer un container |

### Visualiser les logs

| Commande | Description |
|----------|-------------|
| `docker logs nom_container` | Afficher tous les logs |
| `docker logs nom_container --tail=20` | Afficher les 20 dernières lignes |
| `docker logs -f nom_container` | Suivre les logs en temps réel (Ctrl+C pour quitter) |

### Inspecter l'état

| Commande | Description |
|----------|-------------|
| `docker inspect nom_container` | Afficher tous les détails du container |
| `docker inspect --format='{{json .State.Health}}' nom_container` | Vérifier la santé du container |
| `docker network ls` | Lister les réseaux Docker |
| `docker volume ls` | Lister les volumes de données |

---

## Résumé : Procédure quotidienne

### À l'ouverture du PC

```powershell
E:
cd smartflow
docker-compose up -d
docker ps            # Vérifier que tout est Up/Healthy
```

Accède à http://localhost:8000/

### À la fermeture du PC (optionnel mais recommandé)

```powershell
docker-compose down
```

### En cas de problème

```powershell
docker ps                          # Vérifier l'état
docker logs msi_db --tail=40       # Voir les logs de la DB
docker-compose down
docker-compose up -d               # Redémarrer complètement
```

---

## Architecture et ports

```
┌─────────────────────────────────────────────────────────────┐
│                      DOCKER COMPOSE STACK                   │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────┐            ┌──────────────────┐       │
│  │   msi_web        │            │     msi_db       │       │
│  │  (Django App)    │◄──────────►│  (PostgreSQL 15) │       │
│  │  Port: 8000      │            │  Port: 5432      │       │
│  │  Status: Up      │            │  Status: Healthy │       │
│  └──────────────────┘            └──────────────────┘       │
│        ▲                                                      │
│        │                                                      │
│        └──► http://localhost:8000/ (Navigateur)             │
│                                                               │
│  ┌─────────────────────────────────────────────┐            │
│  │        Network: smartflow_default           │            │
│  └─────────────────────────────────────────────┘            │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## Notes importantes

- **Données persistantes** : Les données PostgreSQL sont stockées dans un volume Docker (`pg_data` ou équivalent). Même si tu arrêtes le container, les données restent.
- **Virtualenv** : Tu utilises un virtualenv Python local (`./venv/`). Le container Django l'utilise aussi pour les dépendances.
- **Encodage** : Toujours en UTF-8 sans BOM pour `settings.py` et les fichiers de config.
- **Port 5432** : Ne dois pas être occupé par un service PostgreSQL Windows local. Docker prend la priorité.
- **Redémarrage complet** : Si tu as des doutes, `docker-compose down` suivi de `docker-compose up -d` résout 90% des problèmes.

---

## Contacts & Support

Pour toute question ou problème :
- Vérifier d'abord `docker ps` et `docker logs`
- Essayer un redémarrage complet : `docker-compose down && docker-compose up -d`
- Consulter ce guide ou demander de l'aide

---

**Version du guide :** 1.0 | **Dernière mise à jour :** 19 novembre 2025